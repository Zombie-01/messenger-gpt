"use strict";(()=>{var e={};e.id=345,e.ids=[345],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6544:e=>{e.exports=import("node-fetch")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,s){return s in t?t[s]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,s)):"function"==typeof t&&"default"===s?t:void 0}}})},5631:(e,t,s)=>{s.r(t),s.d(t,{config:()=>d,default:()=>c,routeModule:()=>p});var a={};s.r(a),s.d(a,{default:()=>l});var i=s(1802),o=s(7153),n=s(6249),r=s(4473);function l(e,t){if("GET"===e.method){let e=(0,r.getLogs)();t.status(200).json({logs:e})}else t.setHeader("Allow",["GET"]),t.status(405).end(`Method ${e.method} Not Allowed`)}let c=(0,n.l)(a,"default"),d=(0,n.l)(a,"config"),p=new i.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/logs",pathname:"/api/logs",bundlePath:"",filename:""},userland:a})},6042:e=>{let t={urlProfile:"https://graph.facebook.com/v17.0/me/messenger_profile",urlMesseges:"https://graph.facebook.com/v17.0/me/messages",urlAttachment:"https://graph.facebook.com/v17.0/me/message_attachment",accessToken:process.env.FACEBOOK_ACCESS_TOKEN||"",postbackGetStarted:"GET_STARTED",postbackLearnMore:"Learn More",welcomeMessage:"Welcome to Classical Art! Which artist would you like to learn more about?",chatGptKey:process.env.OPENAI_API_KEY||""};e.exports=t},4473:(e,t,s)=>{s.r(t),s.d(t,{default:()=>f,getLogs:()=>m});let a=require("url");var i=s(6042),o=s.n(i);class n{static{this.welcomeScreenBody=()=>({greeting:[{locale:"default",text:"Welcome {{user_first_name}}! Explore the timeless artwork of legendary artists."}]})}static{this.getStartedBody=()=>({get_started:{payload:"GET_STARTED"}})}constructor(){this.greetingMessageBody=(e,t)=>({recipient:{id:e},message:{text:t}}),this.greetingMessageWithQuickReplies=e=>({recipient:{id:e},messaging_type:"RESPONSE",message:{text:"Which of these artists are you interested in?",quick_replies:[{content_type:"text",title:"Pablo Picasso",payload:"ARTIST_BIO"},{content_type:"text",title:"Michelangelo",payload:"ARTIST_BIO"},{content_type:"text",title:"Vincent van Gogh",payload:"ARTIST_BIO"}]}}),this.artistCarouselBody=(e,t)=>({recipient:{id:e},message:{attachment:{type:"template",payload:{template_type:"generic",elements:t.map(e=>e.toElement())}}}}),this.typingIndicatorBody=(e,t)=>({recipient:{id:e},sender_action:t?"typing_on":"typing_off"}),this.uploadImageBody=e=>({recipient:{id:e},message:{attachment:{type:"image",payload:{url:"https://uploads5.wikiart.org/images/pablo-picasso/female-bust.jpg!Large.jpg",is_reusable:!0}}}})}}class r{constructor(e){this.contentId=e.contentId,this.artistName=e.artistName,this.url=e.url,this.birthDayAsString=e.birthDayAsString,this.image=e.image}toElement(){return{title:this.artistName,subtitle:this.birthDayAsString,image_url:this.image,buttons:[{type:"postback",title:"Learn More",payload:this.artistName}]}}}let l=require("openai"),c=(...e)=>Promise.resolve().then(s.bind(s,6544)).then(({default:t})=>t(...e)),d=async()=>{let e=[223667,204915,225091],t=(await c("https://www.wikiart.org/en/Popular-Artists/alltime/1?json=2&PageSize=1").then(async e=>e.json())).map(e=>new r(e)).filter(t=>e.includes(t.contentId));return console.log(t),t},p=async e=>{let t=o().chatGptKey;try{let s=new l.Configuration({apiKey:t}),a=new l.OpenAIApi(s);return(await a.createChatCompletion({model:"gpt-3.5-turbo",messages:[{role:"user",content:`Write a biography of ${e} that is 150 characters.`}]})).data.choices[0].message.content}catch(e){console.log(e)}},g=(...e)=>Promise.resolve().then(s.bind(s,6544)).then(({default:t})=>t(...e));class h{constructor(){this.handleReceivedMessage=async e=>{e.entry.forEach(async e=>{e.messaging.forEach(async e=>{e.postback&&e.postback.payload==o().postbackGetStarted&&(await this.sendGreeting(e.sender.id,o().welcomeMessage),await this.sendArtistCarousel(e.sender.id)),e.postback&&e.postback.title==o().postbackLearnMore&&(console.log(e),await this.sendArtistBio(e.sender.id,e.postback.payload))})})},this.sendGreeting=async(e,t)=>{let s=new n;await this.sendApi(o().urlMesseges,s.greetingMessageBody(e,t))},this.sendArtistCarousel=async e=>{let t=new n;await this.updateTypingIndicator(e,!0);let s=await d();console.log(t.artistCarouselBody(e,s)),await this.sendApi(o().urlMesseges,t.artistCarouselBody(e,s)),await this.updateTypingIndicator(e,!1)},this.sendApi=async(e,t)=>{let s=new a.URL(e);s.search=new a.URLSearchParams({access_token:o().accessToken});let i=await g(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).catch(e=>console.log(e));console.log(t),i&&i.ok?console.log(await i.json().catch(e=>console.log(e))):console.log(i)},this.updateTypingIndicator=async(e,t)=>{let s=new n;await this.sendApi(o().urlMesseges,s.typingIndicatorBody(e,t))},this.sendArtistBio=async(e,t)=>{let s=new n;await this.updateTypingIndicator(e,!0);let a=await p(t);await this.sendApi(o().urlMesseges,s.greetingMessageBody(e,a)),await this.updateTypingIndicator(e,!1)},this.getAttachmentId=async e=>{let t=new n;await this.sendApi(o().urlMesseges,t.uploadImageBody(e))}}}let u=[],y=(e,t,s=null)=>{let a=new Date().toISOString(),i={timestamp:a,level:e,message:t,data:s||{},id:u.length+1};u.push(i),u.length>1e3&&(u=u.slice(-1e3)),console.log(`[${e}] ${a}: ${t}`,s||"")},m=()=>u;async function f(e,t){if("POST"===e.method)try{let s=e.body;if(y("INFO","Webhook received",{object:s.object}),"page"===s.object)try{let e=new h;await e.handleReceivedMessage(s),y("INFO","Message handled successfully"),t.status(200).send("EVENT_RECEIVED")}catch(e){y("ERROR","Error handling message",{error:e.message}),t.sendStatus(404)}else y("WARN","Invalid object type",{object:s.object}),t.sendStatus(404)}catch(e){y("ERROR","Webhook error",{error:e.message,stack:e.stack}),t.status(500).json({error:"Internal server error"})}else if("GET"===e.method){let s=e.query["hub.mode"],a=e.query["hub.verify_token"],i=e.query["hub.challenge"];y("INFO","Webhook verification request",{mode:s,token:a?"***":"missing"}),s&&a?"subscribe"===s&&a===process.env.WEBHOOK_VERIFY_TOKEN?(y("INFO","Webhook verified"),t.status(200).send(i)):(y("WARN","Invalid verification token"),t.sendStatus(403)):(y("WARN","Missing verification parameters"),t.sendStatus(403))}else t.setHeader("Allow",["GET","POST"]),t.status(405).end(`Method ${e.method} Not Allowed`)}},7153:(e,t)=>{var s;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return s}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(s||(s={}))},1802:(e,t,s)=>{e.exports=s(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var s=t(t.s=5631);module.exports=s})();